# trim changelog included in binary rpms
%global _changelog_trimtime %(date +%s -d "1 year ago")

%if 0%{?fedora} < 22
%define folderview 1
%endif

# enable tests
%global tests 0

Name:    kde-baseapps
Summary: KDE Core Applications 
Epoch:   2000
Version: @VERSION@
Release: @REL@%{?dist}

License: GPLv2 and GFDL
URL:     https://quickgit.kde.org/?p=%{name}.git
%global revision %(echo %{version} | cut -d. -f3)
%if %{revision} >= 50
%global stable unstable
%else
%global stable stable
%endif
Source0: http://download.kde.org/%{stable}/applications/%{version}/src/kde-baseapps-%{version}.tar.xz

## upstreamable patches
# search path for plugins
Patch0: kdebase-4.1.80-nsplugins-paths.patch

# make menuitem Home visible
Patch2: kdebase-4.2.1-home-icon.patch

# fix disabling automatic spell checking in the Konqueror UI (kde#228593)
Patch3: kdebase-4.4.0-konqueror-kde#228593.patch

# add x-scheme-handler/http for konqueror so it can be set
# as default browser in GNOME
Patch5: kde-baseapps-4.14.3-konq_mimetype.patch

## upstream patches

# optional runtime dep for kcm_useraccount, see https://git.reviewboard.kde.org/r/110875/
%if 0%{?fedora} || 0%{?rhel} > 6
Requires: accountsservice
%endif

## Qubes patches
Patch100: kde-baseapps-16.08.3-qubes.patch

%ifnarch s390 s390x
Requires: eject
%endif

# kdepasswd uses chfn
Requires: util-linux

Obsoletes: kdebase < 6:4.7.97-10
Provides:  kdebase = 6:%{version}-%{release}

Obsoletes: kdebase4 < %{version}-%{release}
Provides:  kdebase4 = %{version}-%{release}

BuildRequires: desktop-file-utils
%if 0%{?fedora} < 22
BuildRequires: baloo-devel >= 4.14
BuildRequires: baloo-widgets-devel >= 4.14
BuildRequires: kactivities-devel
BuildRequires: kfilemetadata-devel >= 4.14
%endif
BuildRequires: kdelibs4-devel >= 4.14
%if 0%{?fedora} > 21
BuildRequires: libappstream-glib
%endif
%if 0%{?fedora}
BuildRequires: libtidy-devel
%endif
BuildRequires: pkgconfig
BuildRequires: pkgconfig(glib-2.0)
BuildRequires: pkgconfig(xrender)
BuildRequires: pkgconfig(zlib)

%if 0%{?tests}
%global _kde4_build_tests -DKDE4_BUILD_TESTS:BOOL=ON
# %%check
BuildRequires: dbus-x11 xorg-x11-server-Xvfb
%endif

Requires: %{name}-common = %{epoch}:%{version}-%{release}
%if 0%{?folderview}
Requires: kde-plasma-folderview = 6:%{version}-%{release}
%endif
Requires: kdepasswd = %{epoch}:%{version}-%{release}
Requires: kdialog = %{epoch}:%{version}-%{release}

# for upgrade path, when konsole, kwrite were split out since 4.7.90
%if 0%{?fedora} < 17 && 0%{?rhel} < 7
Requires: konsole
Requires: kwrite
%endif

%description
Metapackage for Core applications of KDE 4, including:
kdepasswd : Changes a UNIX password
kdialog : Nice dialog boxes from shell scripts
keditbookmarks : Bookmark organizer and editor
kfind : File find utility
konqueror : Web browser, file manager and document viewer

%package common
Summary: Common files for %{name}
Conflicts: kde-baseapps < 4.12.0-2
%if ! 0%{?folderview}
Obsoletes: kde-plasma-folderview < 6:%{version}-%{release}
%endif
BuildArch: noarch
%description common
%{summary}

%package libs
Summary: Runtime libraries for %{name}
Obsoletes: kdebase-libs < 6:4.7.97-10
Provides:  kdebase-libs < 6:%{version}-%{release}
Provides:  kdebase-libs%{?_isa} < 6:%{version}-%{release}
Requires: %{name}-common = %{epoch}:%{version}-%{release}
Requires: libkonq%{?_isa} = %{epoch}:%{version}-%{release}
%description libs
%{summary}.

%package devel
Summary:  Development files for %{name}
Obsoletes: kdebase-devel < 6:4.7.97-10
Provides:  kdebase-devel = 6:%{version}-%{release}
Obsoletes: kdebase4-devel < %{version}-%{release}
Provides:  kdebase4-devel = %{version}-%{release}
Requires: %{name}-common = %{epoch}:%{version}-%{release}
Requires: libkonq%{?_isa} = %{epoch}:%{version}-%{release}
Requires: kdelibs4-devel
%description devel
%{summary}.

%package -n kdepasswd
Summary: Changes your UNIX password
Requires: %{name}-common = %{epoch}:%{version}-%{release}
%{?kde_runtime_requires}
%description -n kdepasswd
This application allows you to change your UNIX password.

%package -n kdialog
Summary:  Nice dialog boxes from shell scripts
Requires: %{name}-common = %{epoch}:%{version}-%{release}
%{?kde_runtime_requires}
%description -n kdialog
KDialog can be used to show nice dialog boxes from shell scripts.

%package -n libkonq
Summary: Libkonq shared resources
Requires: %{name}-common = %{epoch}:%{version}-%{release}
%{?kdelibs4_requires}
%description -n libkonq
%{summary}.

%prep
%setup -q -n kde-baseapps-%{version}

%patch0 -p2 -b .nsplugins-paths
%patch2 -p2 -b .home-icon
%patch3 -p2 -b .kde#228593
%patch5 -p1 -b .konq_mimetype

%if ! 0%{?folderview}
sed -i -e 's|^add_subdirectory(folderview)|#add_subdirectory(folderview)|g' plasma/applets/CMakeLists.txt
%endif

%patch100 -p1 -b .qubes

%build
mkdir -p %{_target_platform}
pushd %{_target_platform}
%{cmake_kde4} ..
popd

make %{?_smp_mflags} -C %{_target_platform}


%install
make install/fast DESTDIR=%{buildroot} -C %{_target_platform}

# create/own some dirs 
mkdir -p %{buildroot}%{_kde4_appsdir}/konqueror/{kpartplugins,icons,opensearch}

## unpackaged files
# libs for which there is no (public) api
rm -fv %{buildroot}%{_kde4_libdir}/lib{kbookmarkmodel_,konqueror}private.so
rm -fv %{buildroot}%{_kde4_libdir}/libdolphinprivate4.so
# omit konqsidebarplugin api bits (for now), nothing uses it afaict -- rex
rm -fv %{buildroot}%{_kde4_libdir}/libkonqsidebarplugin.so
rm -fv %{buildroot}%{_kde4_includedir}/konqsidebarplugin.h

# move devel symlinks
mkdir -p %{buildroot}%{_kde4_libdir}/kde4/devel
pushd %{buildroot}%{_kde4_libdir}
for i in lib*.so
do
  case "$i" in
    libkonq.so)
      linktarget=`readlink "$i"`
      rm -fv "$i"
      ln -sf "../../$linktarget" "kde4/devel/$i"
      ;;
    *)
      ;;
  esac
done
popd

# fix documentation multilib conflict in index.cache
for f in konqueror; do
   bunzip2 %{buildroot}%{_kde4_docdir}/HTML/en/$f/index.cache.bz2
   sed -i -e 's!name="id[a-z]*[0-9]*"!!g' %{buildroot}%{_kde4_docdir}/HTML/en/$f/index.cache
   sed -i -e 's!#id[a-z]*[0-9]*"!!g' %{buildroot}%{_kde4_docdir}/HTML/en/$f/index.cache
   bzip2 -9 %{buildroot}%{_kde4_docdir}/HTML/en/$f/index.cache
done

# Qubes cleanup
rm -f %{buildroot}%{_kde4_appsdir}/kbookmark/directory_bookmarkbar.desktop
rm -f %{buildroot}/usr/share/man/man1/kbookmarkmerger.1
rm -f %{buildroot}/usr/share/man/man1/kfind.1
rm -rf %{buildroot}/usr/share/doc/HTML/en/kfind
rm -rf %{buildroot}/usr/share/doc/HTML/en/konqueror
# part of konqueror
rm -f %{buildroot}/usr/share/dbus-1/interfaces/org.kde.FavIcon.xml

%find_lang kdepasswd --with-kde --without-mo


%check
%if 0%{?tests}
export CTEST_OUTPUT_ON_FAILURE=1
## setting semi-arbitrary 30 second timeout, KonqPopupMenuTest, seems to hang or take a really long time --rex
time xvfb-run -a dbus-launch --exit-with-session make -C %{_target_platform}/ test ARGS="--output-on-failure --timeout 30" ||:
%endif
for f in %{buildroot}%{_kde4_datadir}/applications/kde4/*.desktop ; do
  desktop-file-validate $f
done


%post
touch --no-create %{_kde4_iconsdir}/hicolor &> /dev/null ||:
touch --no-create %{_kde4_iconsdir}/oxygen &> /dev/null ||:

%posttrans
gtk-update-icon-cache %{_kde4_iconsdir}/hicolor &> /dev/null ||:
gtk-update-icon-cache %{_kde4_iconsdir}/oxygen &> /dev/null ||:
update-desktop-database -q &> /dev/null ||:

%postun
if [ $1 -eq 0 ] ; then
  touch --no-create %{_kde4_iconsdir}/hicolor &> /dev/null ||:
  touch --no-create %{_kde4_iconsdir}/oxygen &> /dev/null ||:
  gtk-update-icon-cache %{_kde4_iconsdir}/hicolor &> /dev/null ||:
  gtk-update-icon-cache %{_kde4_iconsdir}/oxygen &> /dev/null ||:
  update-desktop-database -q &> /dev/null ||:
fi


%files
# empty metapackage

%files libs
# empty metapackage

%files common
%doc COPYING COPYING.DOC COPYING.LIB


%post -n libkonq -p /sbin/ldconfig
%postun -n libkonq -p /sbin/ldconfig

%files -n libkonq
%{_kde4_libdir}/libkonq.so.5*
%{_kde4_libdir}/kde4/kded_favicons.so
%{_kde4_libdir}/kde4/konq_sound.so
%{_kde4_appsdir}/kbookmark/
%dir %{_kde4_appsdir}/konqueror/
%dir %{_kde4_appsdir}/konqueror/pics/
%{_kde4_appsdir}/konqueror/pics/arrow_*.png
%{_kde4_datadir}/kde4/services/kded/favicons.desktop
%{_kde4_datadir}/kde4/servicetypes/konqdndpopupmenuplugin.desktop
%{_kde4_datadir}/kde4/servicetypes/konqpopupmenuplugin.desktop
%{_kde4_datadir}/templates/.source/*
%{_kde4_datadir}/templates/*.desktop

#files -n libkonq-devel
%files devel
%{_kde4_libdir}/kde4/devel/libkonq.so
%{_kde4_includedir}/knewmenu.h
%{_kde4_includedir}/konq_*.h
%{_kde4_includedir}/konqmimedata.h
%{_kde4_includedir}/kversioncontrolplugin*.h
%{_kde4_includedir}/libkonq_export.h

%files -n kdepasswd -f kdepasswd.lang
%{_kde4_bindir}/kdepasswd
%{_kde4_datadir}/applications/kde4/kdepasswd.desktop
%{_kde4_libdir}/kde4/kcm_useraccount.so
%{_kde4_datadir}/config.kcfg/kcm_useraccount.kcfg
%{_kde4_datadir}/config.kcfg/kcm_useraccount_pass.kcfg
%{_kde4_datadir}//kde4/services/kcm_useraccount.desktop
%dir %{_kde4_appsdir}/kdm
%dir %{_kde4_appsdir}/kdm/pics
%dir %{_kde4_appsdir}/kdm/pics/users/
%{_kde4_appsdir}/kdm/pics/users/*

%files -n kdialog
%{_kde4_bindir}/kdialog
%{_datadir}/dbus-1/interfaces/org.kde.kdialog.ProgressDialog.xml

%changelog
@CHANGELOG@
